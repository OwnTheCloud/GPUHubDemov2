<!DOCTYPE html>
<html>
<head>
    <title>SQL.js Test</title>
</head>
<body>
    <h1>SQL.js Database Test</h1>
    <div id="status">Initializing SQL.js...</div>
    <div id="results"></div>
    
    <script src="https://sql.js.org/dist/sql-wasm.js"></script>
    <script type="text/javascript">
        const statusEl = document.getElementById('status');
        const resultsEl = document.getElementById('results');
        
        async function testSQLjs() {
            try {
                // Initialize SQL.js
                const SQL = await initSqlJs({
                    locateFile: file => `https://sql.js.org/dist/${file}`
                });
                
                // Create a database
                const db = new SQL.Database();
                
                // Create assets table
                db.run(`CREATE TABLE IF NOT EXISTS assets (
                    id TEXT PRIMARY KEY,
                    device_name TEXT NOT NULL,
                    status TEXT,
                    owner_id TEXT,
                    location TEXT,
                    gpu_type TEXT,
                    instance_count INTEGER DEFAULT 1,
                    last_updated DATETIME DEFAULT CURRENT_TIMESTAMP,
                    network_bandwidth TEXT,
                    created_date DATE,
                    notes TEXT
                )`);
                
                // Create owners table
                db.run(`CREATE TABLE IF NOT EXISTS owners (
                    id TEXT PRIMARY KEY,
                    name TEXT NOT NULL,
                    department TEXT,
                    email TEXT,
                    role TEXT
                )`);
                
                // Insert test data
                db.run(`INSERT INTO owners (id, name, department, email, role) 
                        VALUES ('owner-1', 'Test Owner', 'IT', 'test@example.com', 'Admin')`);
                
                db.run(`INSERT INTO assets (id, device_name, status, owner_id, location, gpu_type) 
                        VALUES ('asset-1', 'Test GPU', 'active', 'owner-1', 'US-East', 'h100')`);
                
                // Query with JOIN
                const result = db.exec(`
                    SELECT 
                        a.*,
                        o.name as owner_name,
                        o.email as owner_email
                    FROM assets a
                    LEFT JOIN owners o ON a.owner_id = o.id
                    ORDER BY a.device_name
                `);
                
                statusEl.textContent = 'SQL.js test completed successfully!';
                statusEl.style.color = 'green';
                
                // Display results
                if (result.length > 0) {
                    const columns = result[0].columns;
                    const values = result[0].values;
                    
                    let html = '<h2>Query Results:</h2>';
                    html += '<table border="1" style="border-collapse: collapse; margin: 10px 0;">';
                    html += '<tr>';
                    columns.forEach(col => {
                        html += `<th style="padding: 5px; background: #f0f0f0;">${col}</th>`;
                    });
                    html += '</tr>';
                    
                    values.forEach(row => {
                        html += '<tr>';
                        row.forEach(val => {
                            html += `<td style="padding: 5px;">${val || '-'}</td>`;
                        });
                        html += '</tr>';
                    });
                    html += '</table>';
                    
                    // Show all tables
                    const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table'");
                    if (tables.length > 0) {
                        html += '<h2>Created Tables:</h2>';
                        html += '<ul>';
                        tables[0].values.forEach(row => {
                            html += `<li>${row[0]}</li>`;
                        });
                        html += '</ul>';
                    }
                    
                    resultsEl.innerHTML = html;
                } else {
                    resultsEl.innerHTML = '<p>No results found</p>';
                }
                
                db.close();
                
            } catch (error) {
                statusEl.textContent = 'Error: ' + error.message;
                statusEl.style.color = 'red';
                console.error(error);
            }
        }
        
        testSQLjs();
    </script>
</body>
</html>